# This patch file was generated by NetBeans IDE
# It uses platform neutral UTF-8 encoding and \n newlines.
--- <html>XCodeBuilder.java (<b>Feb 27, 2015 11:50:18 PM</b>)</html>
+++ <html><b>Current File</b></html>
@@ -621,29 +621,7 @@
                 return false;                
             }
             
-            // clean IPA
-            FilePath ipaOutputPath = null;
-            if (ipaOutputDirectory != null && ! StringUtils.isEmpty(ipaOutputDirectory)) {
-            	ipaOutputPath = buildDirectory.child(ipaOutputDirectory);
             	
-            	// Create if non-existent
-            	if (! ipaOutputPath.exists()) {
-            		ipaOutputPath.mkdirs();
-            	}
-            }
-            
-            if (ipaOutputPath == null) {
-            	ipaOutputPath = buildDirectory;
-            }
-            
-            listener.getLogger().println(Messages.XCodeBuilder_cleaningIPA());
-            for (FilePath path : ipaOutputPath.list("*.ipa")) {
-                path.delete();
-            }
-            listener.getLogger().println(Messages.XCodeBuilder_cleaningDSYM());
-            for (FilePath path : ipaOutputPath.list("*-dSYM.zip")) {
-                path.delete();
-            }
             // packaging IPA
             listener.getLogger().println(Messages.XCodeBuilder_packagingIPA());
             List<FilePath> apps = buildDirectory.list(new AppFileFilter());
@@ -680,8 +658,52 @@
                		return false;
                	}
 
+                //
+                
+                // clean IPA
+                FilePath ipaOutputPath = null;
+                if (ipaOutputDirectory != null && ! StringUtils.isEmpty(ipaOutputDirectory)) {                    
                 String lastModified = new SimpleDateFormat("yyyy.MM.dd").format(new Date(app.lastModified()));
 
+                    // If custom .ipa name pattern has been provided, use it and expand version and build date variables
+                    
+                            EnvVars customVars = new EnvVars(
+                                    "BASE_NAME", app.getBaseName().replaceAll(" ", "_"),
+                                    "VERSION", version,
+                                    "SHORT_VERSION", shortVersion,
+                                    "BUILD_DATE", lastModified
+                            );
+                        ipaOutputDirectory = customVars.expand(ipaOutputDirectory);
+                    
+                    
+                    ipaOutputPath = buildDirectory.child(ipaOutputDirectory);
+                    
+                    // Create if non-existent
+                    if (! ipaOutputPath.exists()) {
+                            ipaOutputPath.mkdirs();
+                    }
+                }
+
+                if (ipaOutputPath == null) {
+                    ipaOutputPath = buildDirectory;
+                }
+
+                listener.getLogger().println(Messages.XCodeBuilder_cleaningIPA());
+                for (FilePath path : ipaOutputPath.list("*.ipa")) {
+                    path.delete();
+                }
+                listener.getLogger().println(Messages.XCodeBuilder_cleaningDSYM());
+                for (FilePath path : ipaOutputPath.list("*-dSYM.zip")) {
+                    path.delete();
+                }
+                
+                //
+                
+                
+
+
+                String lastModified = new SimpleDateFormat("yyyy.MM.dd").format(new Date(app.lastModified()));
+
                 String baseName = app.getBaseName().replaceAll(" ", "_") + (shortVersion.isEmpty() ? "" : "-" + shortVersion) + (version.isEmpty() ? "" : "-" + version);
                 // If custom .ipa name pattern has been provided, use it and expand version and build date variables
                 if (! StringUtils.isEmpty(ipaName)) {
