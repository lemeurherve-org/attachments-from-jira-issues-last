commit f618f9d144e10299288fb603dd7eea2f90779408
Author: denis mone <monedenis@gmail.com>
Date:   Sun Dec 1 21:33:56 2019 +0200

    Add an additional check for item.ownerTask

diff --git a/src/main/java/hudson/plugins/buildblocker/BuildBlockerQueueTaskDispatcher.java b/src/main/java/hudson/plugins/buildblocker/BuildBlockerQueueTaskDispatcher.java
index 4d34798..3914153 100644
--- a/src/main/java/hudson/plugins/buildblocker/BuildBlockerQueueTaskDispatcher.java
+++ b/src/main/java/hudson/plugins/buildblocker/BuildBlockerQueueTaskDispatcher.java
@@ -163,9 +163,7 @@ public class BuildBlockerQueueTaskDispatcher extends QueueTaskDispatcher {
         if (checkWasCalledInNodeContext(node) && properties.getBlockLevel().isNode() && !properties.getBlockLevel().isGlobal()) {
             LOG.logp(FINE, getClass().getName(), "checkAccordingToProperties", "calling checkNodeForRunningBuilds");
             Job checkNodeForRunningBuildsResult = jobsMonitor.checkNodeForRunningBuilds(node);
-            if (foundBlocker(checkNodeForRunningBuildsResult)) {
-                return checkNodeForRunningBuildsResult;
-            }
+
             if (properties.getScanQueueFor().isAll()) {
                 LOG.logp(FINE, getClass().getName(), "checkAccordingToProperties", "calling checkNodeForQueueEntries");
                 Job checkNodeForQueueEntriesResult = jobsMonitor.checkNodeForQueueEntries(item, node);
@@ -178,6 +176,10 @@ public class BuildBlockerQueueTaskDispatcher extends QueueTaskDispatcher {
                 if (foundBlocker(checkNodeForBuildableQueueEntriesResult)) {
                     return checkNodeForBuildableQueueEntriesResult;
                 }
+            } else {
+                if (foundBlocker(checkNodeForRunningBuildsResult)) {
+                    return checkNodeForRunningBuildsResult;
+                }
             }
         }
         return null;
@@ -198,7 +200,11 @@ public class BuildBlockerQueueTaskDispatcher extends QueueTaskDispatcher {
     @CheckForNull
     private BuildBlockerProperty getBuildBlockerProperty(Queue.Item item) {
         if (!(item.task instanceof Job)) {
-            return null;
+            if (!(item.task.getOwnerTask() instanceof Job)) {
+                return null;
+            } else {
+                return ((Job<?, ?>) item.task.getOwnerTask()).getProperty(BuildBlockerProperty.class);
+            }
         }
         Job<?,?> job = (Job<?,?>) item.task;
 
